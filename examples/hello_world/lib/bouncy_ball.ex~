defmodule BouncyBall do
  def child_spec(opts) do
    %{
      id: __MODULE__,
      start: {__MODULE__, :start_link, [opts]},
      type: :worker,
      restart: :permanent,
      shutdown: 500
    }
  end

  def start_link(_) do
    :proc_lib.start_link(__MODULE__, :init, [self()])
  end

  def init(parent) do
    winfo = Pocion.info(:bouncy_ball)

    Pocion.call_window(:bouncy_ball, fn ->
      Raylib.set_target_fps(60)
      Raylib.set_trace_log_level(:log_debug)
    end)

    state = %{x: 0, y: 100, dir_y: 1, dir_x: 1, vel: -2, vel_delta: -5, y_delta: 1, width: 8, wheight: winfo.height, wwidth: winfo.width}

    :proc_lib.init_ack(parent, {:ok, self()})

    loop(state)
  end

  def loop(state) do
    Pocion.execute(:hello_world, [
      %{op: :begin_drawing, args: %{}},
      %{op: :clear_background, args: %{color: :raywhite}},
      %{op: :draw_fps, args: %{x: 10, y: 10}},
      %{
        op: :draw_text,
        args: %{text: "Hello world!", x: ostate.x, y: state.y, font_size: 20, color: :lightgray}
      },
      %{op: :end_drawing, args: %{}}
    ])

    vel = state.vel + 0.04;
    dy = vel;
    dx = 1
    dir_y = if(dy > 0, do: 1, else: -1)

    x = state.x + dx
    y = state.y + dy + (dir_y * (state.width-8))
    dist_floor = state.wheight - y
    dist_walls = min(x, state.width - x)
    
    vel = if(dist_floor < 100, do: vel * -1, else: vel)
    dir_x = if(dist_walls > 100, do: -1, else: 1)
    loop(%{state | x: x, y: y, vel: vel, dir_x: dir_x, dir_y: dir_y})
  end
end
